services:

  # 데이터베이스 서비스 정의 (PostgreSQL)
  db:
    container_name: db # 컨테이너 이름을 'db'로 고정
    image: postgres # 공식 PostgreSQL 이미지 사용
    restart: always # 컨테이너 다운 시 자동 재시작
    ports:
      - "5432:5432" # 호스트포트:컨테이너포트 매핑 (외부에서 접속 가능하도록)
    environment:
      POSTGRES_PASSWORD: example # DB 접속 비밀번호 설정 (기본 유지)
    
    # DB 상태 체크 (Healthcheck)
    # pg_isready 명령어로 DB가 연결 요청을 받을 준비가 되었는지 확인합니다.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s # 10초마다 체크
      timeout: 5s   # 응답 대기 시간 5초
      retries: 5    # 실패 시 5번 재시도

  # 애플리케이션 서비스 정의 (Spring Boot)
  app:
    container_name: app # 컨테이너 이름을 'app'으로 고정
    build: . # 현재 디렉토리(Dockerfile이 있는 위치)를 기반으로 이미지 빌드
    ports:
      - "8080:8080" # 호스트포트:컨테이너포트 매핑 (웹 브라우저 접속용)
    environment:
      # 애플리케이션 설정 (application.yml의 변수들과 매핑됨)
      - "POSTGRES_DB_SERVER_ADDRESS=db" # DB 호스트 주소 (컨테이너 이름 'db' 사용)
      - "POSTGRES_DB_SERVER_PORT=5432"
      - "POSTGRES_USER=postgres"
      - "POSTGRES_PASSWORD=example"
    
    # 앱 상태 체크 (Healthcheck)
    # Actuator의 Health Endpoint를 호출하여 앱이 준비되었는지 확인합니다.
    healthcheck:
      test: "curl --fail --silent localhost:8080/actuator/health/readiness | grep UP || exit 1"
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s # 앱 구동 시간을 고려해 체크 시작 전 대기
    
    # 의존성 설정
    # 'db' 서비스가 healthy 상태가 된 후에 'app' 서비스를 시작합니다.
    depends_on:
      db:
        condition: service_healthy
