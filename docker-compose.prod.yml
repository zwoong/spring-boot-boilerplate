services:

  # 데이터베이스 서비스 정의 (PostgreSQL)
  db:
    container_name: db-prod
    image: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: example
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 애플리케이션 서비스 정의 (Spring Boot) - 운영 모드
  app:
    container_name: app-prod
    build:
      context: .
      # 운영 모드: 실행 스테이지 사용 (최적화된 JRE 이미지, JAR만 포함)
      # target을 지정하지 않으면 기본적으로 마지막 스테이지(실행 스테이지) 사용
    ports:
      - "8080:8080"
    environment:
      - "POSTGRES_DB_SERVER_ADDRESS=db"
      - "POSTGRES_DB_SERVER_PORT=5432"
      - "POSTGRES_USER=postgres"
      - "POSTGRES_PASSWORD=example"
    # 운영 모드: 볼륨 마운트 없음 (이미지 내부의 JAR만 사용)
    # volumes:
    #   - ./src:/app/src:rw  # 운영 모드에서는 소스코드 마운트 불필요
    #   - ./build:/app/build:rw
    
    # 운영 모드: Dockerfile의 ENTRYPOINT 사용 (java -jar app.jar)
    # command를 지정하지 않으면 Dockerfile의 ENTRYPOINT가 실행됨
    
    healthcheck:
      test: "curl --fail --silent localhost:8080/actuator/health/readiness | grep UP || exit 1"
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    
    depends_on:
      db:
        condition: service_healthy
